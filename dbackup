#!/bin/bash

base_path="__database"
db_server_name='localhost'
db_user_name='root'
db_password=''
database_name='test_db_1'

function db_backup() {
  if [ ! -d "${base_path}/structure" ]
  then
    mkdir -p "${base_path}/structure"
  fi
  if [ ! -d "${base_path}/data" ]
  then
    mkdir -p "${base_path}/data"
  fi
  eval rm "${base_path}/data/*"

  if [[ ${development_env} == 'xampp' ]]
  then
    ${mysqldump_path} --routines -h ${db_server_name} -u ${db_user_name} -p${db_password} ${database_name} > "${base_path}/structure/${database_name}.sql"
  elif [[ ${development_env} == 'docker' ]]
  then
    echo 'Docker-Backup has not impemented yet.'
	exit
  elif [[ ${development_env} == 'vagrant' ]]
  then
    echo 'Vagrant-Backup has not impemented yet.'
	exit
  fi
}

function php_execute() {
  php_command="$1"
  ${php_path} ${php_command}
}

function setup_environment {
  original_pwd="${PWD}"
  cd "${base_path}"

  # Setup Composer
  ${php_path} -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  ${php_path} -r "if (hash_file('sha384', 'composer-setup.php') === '55ce33d7678c5a611085589f1f3ddf8b3c52d662cd01d4ba75c0ee0459970c2200a51f492d557530c71c15d8dba01eae') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
  ${php_path} composer-setup.php
  ${php_path} -r "unlink('composer-setup.php');"
  mv composer.phar composer.phar
  
  # Setup [FakerPHP/Faker](https://github.com/FakerPHP/Faker)
  ${php_path} composer.phar require fakerphp/faker
}

development_env="$1" # Development Environment: xampp/docker/vagrant
work_type="$2" # Work Type: backup/restore/fetch

if [[ ( ${development_env} != 'xampp' && ${development_env} != 'docker' && ${development_env} != 'vagrant' ) || ( ${work_type} != 'backup' && ${work_type} != 'php' && ${work_type} != 'setup' ) ]]
then
  echo "Please Provide Argument-1 (xampp/docker/vagrant) and Argument-2 (backup/php/setup)"
  exit
fi

operating_system=$(uname -s)
if [[ ${development_env} == 'xampp' ]]
then
  if [[ ${operating_system} == 'Linux' ]]
  then
    mysqldump_path=''
    mysql_path=''
	php_path=''
	editor_open_command="${linux_editor} "
  else # Windows-OS
    mysqldump_path='../../mysql/bin/mysqldump.exe'
    mysql_path='../../mysql/bin/mysql.exe'
	php_path='../../php/php.exe'
	editor_open_command="start ${windows_editor} "
  fi
elif [[ ${development_env} == 'docker' ]]
then
  mysqldump_path='mysqldump'
  mysql_path='mysql'
elif [[ ${development_env} == 'vagrant' ]]
then
  mysqldump_path='/bin/mysqldump' # Laravel-Homestead
  mysql_path='/bin/mysql' # Laravel-Homestead
fi


if [[ ${work_type} == 'backup' ]]
then
  db_backup
elif [[ ${work_type} == 'php' ]]
then
  php_execute "$3"
elif [[ ${work_type} == 'setup' ]]
then
  setup_environment
fi
